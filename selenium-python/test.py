#  Copyright 2025 Google LLC
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

import logging
import pytest
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service

# The chrome and chromedriver installation can take some time.
# Give 5 minutes to install everything.
TIMEOUT = 5 * 60 * 1000


@pytest.fixture(scope="module")
def driver():
    # By default, the test uses the latest stable Chrome version.
    # Replace the "stable" with the specific browser version if needed,
    # e.g. 'canary', '115' or '144.0.7534.0' for example.
    browser_version = "stable"

    options = Options()
    options.add_argument("--headless")
    options.add_argument("--no-sandbox")
    # options.add_argument("--remote-debugging-port=9222")
    options.browser_version = browser_version

    service = Service(service_args=["--log-path=chromedriver.log", "--verbose"])

    driver = webdriver.Chrome(options=options, service=service)

    yield driver

    driver.quit()


@pytest.mark.timeout(TIMEOUT)
def test_should_be_able_to_navigate_to_google_com(driver):
    """This test is intended to verify the setup is correct."""
    driver.get("https://www.google.com")
    logging.info(driver.title)
    assert driver.title == "Google"


@pytest.mark.timeout(TIMEOUT)
def test_issue_reproduction(driver):
    """
    This test reproduces the bug where a new tab is created in the primary window
    instead of the current window.
    """
    # 1. Open the initial window and navigate to Google.
    driver.get("https://www.google.com")
    initial_window_handle = driver.current_window_handle
    first_window_info = driver.execute_cdp_cmd("Browser.getWindowForTarget", {})

    # 2. Open a new tab and navigate to about.google.com
    driver.switch_to.new_window("tab")
    driver.get("https://about.google.com")

    # 3. Open a new window and navigate to maps.google.com.
    driver.switch_to.new_window("window")
    driver.get("https://maps.google.com")
    new_window_handle = driver.current_window_handle
    second_window_info = driver.execute_cdp_cmd("Browser.getWindowForTarget", {})

    # 4. Open a new tab and navigate to photos.google.com.
    driver.switch_to.new_window("tab")
    driver.get("https://photos.google.com")

    last_tab_info = driver.execute_cdp_cmd("Browser.getWindowForTarget", {})
    logging.info(f"Window Info for new window: {{window_info}}")


    assert last_tab_info["windowId"] != first_window_info["windowId"], "New tab was opened in first window"
    assert last_tab_info["windowId"] == second_window_info["windowId"], "New tab was not opened in second window"